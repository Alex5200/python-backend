# Auth API: JWT + Session Cookies + RBAC

–ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- **JWT** ‚Äî –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, SPA, –≤–Ω–µ—à–Ω–∏—Ö API.
- **–°–µ—Å—Å–∏–∏ –≤ PostgreSQL** ‚Äî –¥–ª—è –≤–µ–±-–±—Ä–∞—É–∑–µ—Ä–æ–≤ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ SSR, logout –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é).

---

## üîß –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **FastAPI** ‚Äî –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **PostgreSQL** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–µ—Å—Å–∏–π
- **SQLAlchemy** ‚Äî ORM
- **pwdlib** ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
- **python-jose** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT

---

## üìÅ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

| –ü—É—Ç—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `main.py` | –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤, —Å–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ RBAC |
| `database.py` | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL, `engine`, `SessionLocal`, `Base` |
| `models.py` | –ú–æ–¥–µ–ª–∏: `User` (—Å `role_id`), `UserSession`, `Role` |
| `schemas.py` | –°—Ö–µ–º—ã Pydantic –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–æ–∫–µ–Ω–æ–≤ |
| `security.py` | –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (`pwdlib`), JWT (`python-jose`), `get_current_user_from_jwt` |
| `auth.py` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, —Å–µ—Å—Å–∏–∏, –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ, –æ—Ç–∑—ã–≤ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π |
| `rbac.py` | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ `is_admin`, `require_role`, —Å–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ `seed_rbac_minimal` |
| `routes_admin.py` | –ê–¥–º–∏–Ω-API –ø–æ —Ä–æ–ª—è–º –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º |
| `routes_resources.py` | Mock-—Ä–µ—Å—É—Ä—Å—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ–ª–µ–π (user/admin) |
| `mock_data.py` | –ú–æ–∫-–¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ë–î: –ø—Ä–∏–º–µ—Ä—ã —Ä–æ–ª–µ–π/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É—Ç–∏–ª–∏—Ç—ã |

---

## üöÄ –ó–∞–ø—É—Å–∫

–í–∞—Ä–∏–∞–Ω—Ç A: –õ–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ Docker)

1. –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
    ```bash
    pip install -r requirements.txt
    ```
2. –ù–∞—Å—Ç—Ä–æ–π `.env.dev`:
    ```
    DATABASE_URL=postgresql://user:password@localhost/auth_db
    SECRET_KEY=–≤–∞—à_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á_–¥–ª–∏–Ω–æ–π_–º–∏–Ω–∏–º—É–º_32_—Å–∏–º–≤–æ–ª–∞
    ```
3. –ó–∞–ø—É—Å–∫:
    ```
    python main.py
    ```

–í–∞—Ä–∏–∞–Ω—Ç B: Docker Compose (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –°–æ–∑–¥–∞–π `.env` —Ä—è–¥–æ–º —Å `docker-compose.yml` –∏ –∑–∞–¥–∞–π `SECRET_KEY` (–º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∑–∞ –æ—Å–Ω–æ–≤—É `.env.example`).
2. –°–æ–±–µ—Ä–∏ –∏ –∑–∞–ø—É—Å—Ç–∏:
    ```bash
    docker compose up -d --build
    ```
3. –û—Ç–∫—Ä–æ–π `http://localhost:8000` (API), Postgres –Ω–∞ `localhost:5432`.
4. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:
    ```bash
    docker compose down
    ```

## ‚ö° –ó–∞–ø—É—Å–∫ –±–µ–∑ PostgreSQL (SQLite in-memory)

–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ü–µ–ª–∏–∫–æ–º –±–µ–∑ –≤–Ω–µ—à–Ω–µ–π –ë–î ‚Äî –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤ –ø–∞–º—è—Ç–∏ (–ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏):

Windows PowerShell:
```powershell
$env:USE_IN_MEMORY_DB="1"
$env:SECRET_KEY="dev_secret_please_change"
python main.py
```

Linux/macOS:
```bash
export USE_IN_MEMORY_DB=1
export SECRET_KEY=dev_secret_please_change
python main.py
```

–ì–æ—Ç–æ–≤—ã–µ —É—á—ë—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
- admin: admin@example.com / AdminPass123
- user: user@example.com / UserPass123

–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:
- GET /resources/articles ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ —Ä–æ–ª—è–º user –∏ admin
- POST /resources/articles ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ admin

---

## üîê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ä–æ–ª–∏ 

–°—É—â–Ω–æ—Å—Ç–∏:
- `Role(name)` ‚Äî —Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `admin`, `user`).
- `User.role_id` ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞:
- –ù–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Üí 401.
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–µ–∑ –Ω—É–∂–Ω–æ–π —Ä–æ–ª–∏ ‚Üí 403.

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é `require_role(*role_names)` –≤ `rbac.py`.

–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Å–µ—Å—Å–∏–∏:
- JWT –¥–ª—è API (Bearer), —Å–µ—Å—Å–∏–∏ –≤ –ë–î –¥–ª—è logout –∏ SSR-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã: `/register`, `/login`, `/logout`, `/profile`, `/account` (soft delete).

–°–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–µ–π:
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ä–æ–ª–∏: `admin`, `user`.

–ê–¥–º–∏–Ω-API (`/admin`, —Ç–æ–ª—å–∫–æ –¥–ª—è `admin`):
- `POST /admin/roles` ‚Äî —Å–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å.
- `GET /admin/roles` ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π.
- `POST /admin/set-user-role` ‚Äî –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

Mock-—Ä–µ—Å—É—Ä—Å—ã (`/resources`):
- `GET /resources/articles` ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ —Ä–æ–ª—è–º `user` –∏ `admin`.
- `POST /resources/articles` ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ —Ä–æ–ª–∏ `admin`.

–ú–æ–∫-–¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ë–î:
- –í —Ñ–∞–π–ª–µ `mock_data.py` –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ —Ä–æ–ª–∏/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ø—Ä–æ—Å—Ç—ã–µ —É—Ç–∏–ª–∏—Ç—ã.

---

## üîë –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ Swagger (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ä–æ–ª–∏) —Å–¥–µ–ª–∞–ª –ø–æ –¥–µ—Ñ–æ–ª—Ç—É —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–ª–µ–ª—è admin –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

Swagger –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ `/docs`.

1) –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å
- `POST /register` ‚Äî —É–∫–∞–∂–∏—Ç–µ email/–ø–∞—Ä–æ–ª—å/–§–ò–û.

2) –í–æ–π–¥–∏—Ç–µ –∏ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω
- `POST /login` (form-data: `email`, `password`).
- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `access_token` –∏–∑ –æ—Ç–≤–µ—Ç–∞.

3) –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Swagger —á–µ—Ä–µ–∑ Bearer
- –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É Authorize –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É.
- –í –ø–æ–ª–µ HTTPBearer –≤—Å—Ç–∞–≤—å—Ç–µ –¢–û–õ–¨–ö–û —Å–∞–º —Ç–æ–∫–µ–Ω (–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ `Bearer ` ‚Äî UI –¥–æ–±–∞–≤–∏—Ç –µ–≥–æ —Å–∞–º).
- –ù–∞–∂–º–∏—Ç–µ Authorize ‚Üí Close.

4) –†–æ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –í —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ä–æ–ª—å `admin` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–¥–ª—è —É–ø—Ä–æ—â—ë–Ω–Ω–æ–≥–æ –¥–µ–º–æ). –≠—Ç–æ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `auth.py`.

–°–º–µ–Ω–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-API:
- –ü–æ–ª—É—á–∏—Ç–µ –≤–∞—à `user_id` —á–µ—Ä–µ–∑ `GET /profile`.
- –£–∑–Ω–∞–π—Ç–µ `role_id` —Ä–æ–ª–∏ –∏–∑ `GET /admin/roles`.
- –í—ã–∑–æ–≤–∏—Ç–µ `POST /admin/set-user-role` —Å —Ç–µ–ª–æ–º: `{ "user_id": "<uuid>", "role_id": "<uuid>" }`.

---

## ‚öôÔ∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –î–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö cookie –≤ –ø—Ä–æ–¥ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –≤–∫–ª—é—á–∞–π—Ç–µ `secure=True` –∏ –ø—Ä–æ–¥—É–º—ã–≤–∞–π—Ç–µ `SameSite`.
- –ü—Ä–∏ –º—è–≥–∫–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –æ—Ç–∑—ã–≤–∞–µ—Çc—è –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.


# –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

<img src="./—Å—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.png" />